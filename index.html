<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>COA | CTT - An√°lise de Ritmo & Conduta</title>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#0a0f1d;
      --bg2:#0b1633;
      --text:#eaf0ff;
      --muted:#b7c6ff;
      --good:#19c37d;
      --warn:#ffb020;
      --bad:#ff4d4d;
      --btn:#2ea8ff;
      --btn2:#273659;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.03);
      --stroke: rgba(255,255,255,.12);
      --shadow: 0 10px 30px rgba(0,0,0,.38);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      background:
        radial-gradient(1100px 700px at 15% 0%, rgba(46,168,255,.26) 0%, rgba(10,15,29,0) 55%),
        radial-gradient(900px 650px at 85% 10%, rgba(255,122,24,.16) 0%, rgba(10,15,29,0) 55%),
        radial-gradient(700px 550px at 55% 60%, rgba(25,195,125,.10) 0%, rgba(10,15,29,0) 60%),
        linear-gradient(180deg, var(--bg2), var(--bg));
      color:var(--text);
      padding:22px;
    }

    .glow {
      position:fixed; inset:auto 0 0 0; height:160px; pointer-events:none;
      background: radial-gradient(closest-side at 50% 100%, rgba(46,168,255,.20), rgba(10,15,29,0));
      filter: blur(2px);
      opacity:.75;
    }

    header{
      max-width:1480px;
      margin:0 auto 14px auto;
      display:flex;
      justify-content:space-between;
      gap:14px;
      align-items:flex-end;
      position:relative;
    }
    header h1{
      margin:0;
      font-size:22px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    header .sub{
      color:var(--muted);
      font-size:12.5px;
      margin-top:6px;
      line-height:1.2rem;
    }
    .topRight{ display:flex; gap:10px; align-items:center; justify-content:flex-end; flex-wrap:wrap; }
    .chip{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding:8px 10px;
      border-radius:999px;
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
      position:relative;
      overflow:hidden;
    }
    .chip b{ color:var(--text); font-weight:900; }

    /* ‚úÖ Luzes piscando (somente quando status exige) */
    .chip.pulse::after{
      content:"";
      position:absolute; inset:-40px -40px -40px -40px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.16), rgba(255,255,255,0) 55%);
      animation: pulseGlow 1.15s infinite;
      pointer-events:none;
      opacity:.9;
    }
    @keyframes pulseGlow{
      0%{ transform:scale(0.6); opacity:.15; }
      45%{ transform:scale(1.1); opacity:.35; }
      100%{ transform:scale(1.25); opacity:.08; }
    }

    .menuBtn{
      width:44px;height:44px;border-radius:14px;display:grid;place-items:center;
      cursor:pointer;border:1px solid rgba(255,255,255,.14);background: rgba(0,0,0,.25);
      color:var(--text);font-weight:950;user-select:none;
    }
    .menu{
      position:absolute;right:0;top:58px;width:360px;border-radius:14px;border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.72);box-shadow: 0 10px 30px rgba(0,0,0,.45);
      overflow:hidden;display:none;z-index:50;backdrop-filter: blur(8px);
    }
    .menu.open{ display:block; }
    .menu .item{
      padding:14px 14px;border-bottom:1px solid rgba(255,255,255,.10);cursor:pointer;color:var(--text);
      font-weight:950;font-size:13.5px;
      display:flex;justify-content:space-between;align-items:center;
    }
    .menu .item:hover{ background: rgba(255,255,255,.06); }
    .menu .item:last-child{ border-bottom:0; }
    .menu .item small{ color: var(--muted); font-weight:800; font-size:11px; }

    .wrap{ max-width:1480px;margin:0 auto;display:grid;grid-template-columns: 610px 1fr;gap:16px; }

    .card{
      background: linear-gradient(180deg, var(--card), var(--card2));
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }

    /* ‚úÖ Strobe visual leve em ALERTA/CR√çTICO */
    .card.strobe::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(closest-side at 15% 10%, rgba(255,176,32,.22), rgba(255,255,255,0)),
                  radial-gradient(closest-side at 80% 25%, rgba(255,77,77,.22), rgba(255,255,255,0));
      opacity:.0;
      animation: strobe 1.1s infinite;
      pointer-events:none;
    }
    .card.strobe.bad::before{ opacity:.18; animation-duration: .85s; }
    .card.strobe.warn::before{ opacity:.14; animation-duration: 1.1s; }
    @keyframes strobe{
      0%{ filter: blur(10px); opacity:.06; }
      40%{ filter: blur(18px); opacity:.18; }
      100%{ filter: blur(24px); opacity:.07; }
    }

    .card .hd{
      padding:14px;border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;justify-content:space-between;align-items:center;gap:10px;
    }
    .hd h2{ margin:0;font-size:14px;letter-spacing:.3px; }
    .hd .hint{ color:var(--muted);font-size:12px; }
    .card .bd{ padding:14px; }

    label{ display:block;font-size:12px;color:var(--muted);margin-bottom:6px; }
    input, select, textarea{
      width:100%;background: rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.14);
      color:var(--text);padding:10px;border-radius:12px;outline:none;font-size:14px;
    }
    textarea{ min-height:100px; resize:vertical; }
    input:focus, select:focus, textarea:focus{ border-color: rgba(46,168,255,.8);box-shadow: 0 0 0 3px rgba(46,168,255,.18); }
    input[readonly]{ opacity:0.85;border-style:dashed;cursor:not-allowed; }
    input[disabled]{ opacity:0.85; cursor:not-allowed; }

    .grid2{ display:grid;grid-template-columns:1fr 1fr;gap:10px; }
    .grid3{ display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px; }

    .btnRow{ display:flex;flex-wrap:wrap;gap:10px;margin-top:12px; }
    button{
      border:0;cursor:pointer;padding:11px 14px;border-radius:12px;font-weight:950;font-size:13px;
      color:#07101f;background: var(--btn);box-shadow: 0 10px 20px rgba(46,168,255,.22);
      display:flex;gap:8px;align-items:center;
    }
    button.secondary{
      background: #273659;color: var(--text);border:1px solid rgba(255,255,255,.12);
      box-shadow:none;font-weight:950;
    }
    button.ghost{
      background: rgba(255,255,255,.06);
      color: var(--text);
      border:1px solid rgba(255,255,255,.14);
      box-shadow:none;
    }

    .alert{
      margin-top:12px;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);color:var(--muted);line-height:1.35rem;font-size:13px;
    }
    .alert b{ color:var(--text); }

    .alert.good{ border-color: rgba(25,195,125,.35); background: rgba(25,195,125,.10); }
    .alert.warn{ border-color: rgba(255,176,32,.35); background: rgba(255,176,32,.10); }
    .alert.bad{  border-color: rgba(255,77,77,.35);  background: rgba(255,77,77,.10); }

    .miniNote{ margin-top:10px;color:var(--muted);font-size:12px;line-height:1.15rem; }

    .main{ display:grid;grid-template-rows: auto auto 1fr;gap:16px; }

    .kpis{ display:grid;grid-template-columns: repeat(4, 1fr);gap:10px; }
    .kpi{
      border:1px solid rgba(255,255,255,.10);background: rgba(0,0,0,.22);
      border-radius:14px;padding:12px;min-height:82px;
    }
    .kpi .t{ color:var(--muted);font-size:12px; }
    .kpi .v{ font-size:18px;font-weight:950;margin-top:6px; }
    .kpi .s{ color:var(--muted);font-size:12px;margin-top:6px; }

    .canvasWrap{ border:1px solid rgba(255,255,255,.10);background: rgba(0,0,0,.24);border-radius:14px;padding:10px; }
    canvas{ width:100% !important;height:450px !important; }

    .tableWrap{ border:1px solid rgba(255,255,255,.10);background: rgba(0,0,0,.22);border-radius:14px;overflow:hidden; }
    table{ width:100%;border-collapse:collapse;font-size:12px; }
    thead th{
      text-align:left;padding:10px;background: rgba(255,255,255,.06);color: var(--muted);
      border-bottom:1px solid rgba(255,255,255,.10);position:sticky;top:0;z-index:2;
    }
    tbody td{ padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.06);color:var(--text); }
    tbody tr:hover td{ background: rgba(255,255,255,.03); }

    .pill{
      padding:4px 8px;border-radius:999px;font-weight:950;display:inline-block;border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);font-size:11px;
    }
    .pill.good{ border-color: rgba(25,195,125,.35); color:#b9ffe1; }
    .pill.warn{ border-color: rgba(255,176,32,.35); color:#ffe3b4; }
    .pill.bad{  border-color: rgba(255,77,77,.35); color:#ffb9b9; }

    .sectionBox{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius:14px;
      padding:12px;
      margin-top:10px;
    }
    .sectionBox h3{
      margin:0 0 8px 0;
      font-size:13px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .analysisHdRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:10px;
    }
    .editPencil{
      display:none;
      cursor:pointer;
      width:38px;height:38px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color:var(--text);
      font-weight:950;
      user-select:none;
      align-items:center;
      justify-content:center;
    }
    .editPencil.show{ display:flex; }
    .editPencil:hover{ background: rgba(255,255,255,.10); }

    .modalOverlay{
      position:fixed;inset:0;background: rgba(0,0,0,.70);
      display:none;align-items:center;justify-content:center;z-index:120;padding:18px;
    }
    .modalOverlay.open{ display:flex; }
    .modal{
      width:min(980px, 100%);
      max-height: calc(100vh - 40px);
      border-radius:16px;background:#000;border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 10px 30px rgba(0,0,0,.55);overflow:hidden;
      display:flex;flex-direction:column;
    }
    .modalHd{
      padding:14px;border-bottom:1px solid rgba(255,255,255,.12);
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      flex: 0 0 auto;
    }
    .modalHd h3{ margin:0;font-size:14px;letter-spacing:.2px; }
    .modalClose{
      cursor:pointer;padding:8px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);color:var(--text);font-weight:950;
    }
    .modalBd{
      padding:14px;color:#d9e4ff;font-size:13px;line-height:1.55rem;
      overflow:auto;
      flex: 1 1 auto;
      overscroll-behavior: contain;
    }
    .box{
      margin-top:10px;border:1px solid rgba(255,255,255,.14);background: rgba(255,255,255,.05);
      border-radius:14px;padding:12px;
    }
    .modalBd h4{ margin:0 0 6px 0;font-size:13px; }
    .toolbar{ display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;align-items:center; }
    .toolbar .spacer{ flex:1; }

    .pdfStage{
      position:fixed;left:-99999px;top:-99999px;
      width:1400px;
      background:#000;
      color:#fff;
      border:1px solid #222;
    }
    .pdfPage{
      width:1400px;
      padding:18px;
    }
    .pdfHead{
      display:flex;justify-content:space-between;align-items:flex-start;gap:16px;
      border-bottom:1px solid rgba(255,255,255,.12);
      padding-bottom:10px;margin-bottom:10px;
    }
    .pdfHead .t1{ font-weight:950;font-size:18px; }
    .pdfHead .t2{ color:#c8d4ff;font-size:12px;margin-top:4px;line-height:1.2rem; }
    .pdfGrid{
      display:grid;
      grid-template-columns: 1.2fr 1fr;
      gap:14px;
      align-items:stretch;
    }
    .pdfPanel{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      border-radius:14px;
      padding:12px;
      min-height: 520px;
      display:flex;
      flex-direction:column;
    }
    .pdfPanel h4{ margin:0 0 8px 0;font-size:13px;color:#c8d4ff; }
    .pdfAnalysis{
      font-size:12.6px;
      line-height:1.42rem;
      color:#e8efff;
      white-space:pre-wrap;
      flex:1;
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      background: rgba(0,0,0,.28);
      padding:10px;
    }

    @media (max-width: 1280px){
      .wrap{ grid-template-columns: 1fr; }
      .kpis{ grid-template-columns: repeat(2,1fr); }
      canvas{ height:380px !important; }
    }
  </style>
</head>

<body>
<div class="glow"></div>

<header id="hdr">
  <div>
    <h1>üì° CTT | An√°lise de Ritmo & Conduta - COA</h1>
    <div class="sub">
      Unidade: <b id="hdrUnidade">‚Äî</b> ‚Ä¢ Gerado em: <b id="hdrData">‚Äî</b><br>
      üì¶ Estoque em <b>conjuntos (inteiro)</b> ‚Ä¢ üöö Entrada agr√≠cola / üè≠ Moagem ind√∫stria em <b>t/h</b> ‚Ä¢ Resultado em <b>toneladas</b>
    </div>
  </div>

  <div class="topRight">
    <div class="chip" id="chipStatusWrap">üß≠ Status: <b id="chipStatus">‚Äî</b></div>
    <div class="chip" id="chipHoraWrap">‚è±Ô∏è Hora cr√≠tica: <b id="chipHoraCritica">‚Äî</b></div>
    <div class="chip" id="chipAcaoWrap">üéöÔ∏è Conduta: <b id="chipAcao">‚Äî</b></div>

    <div class="menuBtn" id="menuBtn">‚ò∞</div>
    <div class="menu" id="menu">
      <div class="item" id="menuSimular">üß™ Simular cen√°rio <small>carrega exemplo</small></div>
      <div class="item" id="menuMensagem">üì® Gerar mensagem da an√°lise <small>texto pronto</small></div>
      <div class="item" id="menuCtt">üìò Sobre CTT & C√°lculos <small>tutorial</small></div>
      <div class="item" id="menuFechar">‚úñ Fechar</div>
    </div>
  </div>
</header>

<div class="wrap">

  <!-- ESQUERDA -->
  <div class="card" id="leftCard">
    <div class="hd">
      <h2>‚öôÔ∏è Configura√ß√£o</h2>
      <div class="hint">par√¢metros da unidade travados (somente leitura)</div>
    </div>
    <div class="bd">
      <div class="grid2">
        <div>
          <label>üè≠ Unidade</label>
          <select id="inUnidade">
            <option>Mandu</option>
            <option>Cruz Alta</option>
            <option>S√£o Jos√©</option>
            <option>Vertente</option>
            <option>Tanabi</option>
          </select>
        </div>
        <div>
          <label>üß™ Densidade (t por conjunto)</label>
          <input id="inDens" type="number" value="70" step="0.1">
        </div>
      </div>

      <div class="grid2" style="margin-top:10px;">
        <div>
          <label>üß† Modo</label>
          <select id="inModo">
            <option value="analise" selected>Modo an√°lise (aumentar / reduzir / manter)</option>
            <option value="retomar">Modo retomar moagem (melhor momento de soltar)</option>
          </select>
        </div>
        <div id="cruzAltaBox" style="display:none;">
          <label>‚öóÔ∏è Cruz Alta</label>
          <div style="display:flex;gap:10px;align-items:center;">
            <label style="margin:0;display:flex;gap:10px;align-items:center;color:var(--muted);font-size:12px;">
              <input id="inDifOff" type="checkbox" style="width:18px;height:18px;accent-color:#2ea8ff;">
              Desligar 1 difusor (m√≠n. 250 t/h)
            </label>
          </div>
        </div>
      </div>

      <div class="grid3" style="margin-top:10px;">
        <div><label>üìâ M√≠nimo (t)</label><input id="inMin" type="number" readonly></div>
        <div><label>üìà M√°ximo (t)</label><input id="inMax" type="number" readonly></div>
        <div><label>‚ö†Ô∏è Zona de risco (t)</label><input id="inRiscoT" type="number" readonly></div>
      </div>

      <div class="grid3" style="margin-top:10px;">
        <div><label>üè≠ Moagem nominal (t/h)</label><input id="inNominal" type="number" readonly></div>
        <div><label>üßØ Moagem m√≠nima (t/h)</label><input id="inMinMoagem" type="number" readonly></div>
        <div>
          <label>‚è≥ Per√≠odo (h)</label>
          <select id="inHorizonte">
            <option>6</option>
            <option>12</option>
            <option selected>24</option>
          </select>
        </div>
      </div>

      <div class="grid2" style="margin-top:10px;">
        <div><label>üïí Hora atual (auto)</label><input id="inHoraAtual" type="text" disabled></div>
        <div><label>üì¶ Estoque atual (conj)</label><input id="inEstoqueAtual" type="number" step="1" placeholder="ex: 18"></div>
      </div>

      <!-- REALIZADO 3h -->
      <div class="sectionBox">
        <h3>‚úÖ Realizado (√∫ltimas 3h)</h3>
        <div class="miniNote" style="margin:0 0 10px 0;">
          üì¶ Estoque em <b>conj</b> ‚Ä¢ üöö Entrada agr√≠cola em <b>t/h</b> ‚Ä¢ üè≠ Moagem ind√∫stria em <b>t/h</b>
        </div>

        <div class="tableWrap" style="border-radius:12px;">
          <table>
            <thead>
              <tr>
                <th style="width:90px;">Hora</th>
                <th>üì¶ Estoque (conj)</th>
                <th>üöö Entrada agr√≠cola (t/h)</th>
                <th>üè≠ Moagem ind√∫stria (t/h)</th>
              </tr>
            </thead>
            <tbody id="lastBody"></tbody>
          </table>
        </div>

        <div class="btnRow" style="margin-top:10px;">
          <button class="secondary" id="btnTendencia">üìå Preencher tend√™ncia</button>
          <button class="ghost" id="btnArmarSom">üîä Armar som</button>
        </div>

        <div class="miniNote" style="margin-top:8px;">
          Mudou qualquer n√∫mero? Clique em <b>Analisar</b> de novo que recalcula tudo (gr√°fico, tabela e an√°lise batendo).
        </div>
      </div>

      <!-- MOTIVO -->
      <div class="sectionBox">
        <h3>üßæ Motivo do cen√°rio (texto-base)</h3>
        <label>
          Escreva do seu jeito (padr√£o COA). A an√°lise replica a sua l√≥gica e padroniza termos sem inventar.
        </label>
        <textarea id="inMotivo" placeholder="Digite aqui o motivo do cen√°rio atual..."></textarea>

        <div class="miniNote">
          Padr√µes inteligentes: quebra/quebrou/parada/manuten√ß√£o ‚Üí <b>indisponibilidade mec√¢nica</b>; colhedora/transbordo/caminh√£o ‚Üí especifica o ativo; chuva/interdi√ß√£o/fila/balan√ßa/turno ‚Üí classifica cen√°rio e sugere a√ß√£o.
        </div>

        <div class="btnRow" style="margin-top:10px;">
          <button class="secondary" id="btnMelhorarMotivo">üß† Melhorar motivo (IA local)</button>
        </div>
      </div>

      <!-- TEND√äNCIA -->
      <div class="sectionBox">
        <h3>üîÆ Tend√™ncia (a partir da hora atual)</h3>
        <div class="miniNote" style="margin:0 0 10px 0;">
          Ajuste por hora em <b>t/h</b>. Conta: <b>estoque(t+1) = estoque(t) + entrada ‚àí moagem</b>. (Estoque n√£o fica negativo.)
        </div>
        <div class="tableWrap" id="futureWrap" style="border-radius:12px; max-height:320px; overflow:auto;"></div>

        <div class="analysisHdRow">
          <div style="color:var(--muted);font-weight:950;font-size:12px;">üßæ Informativo (pronto pra gest√£o)</div>
          <div class="editPencil" id="btnEditPencil" title="Editar an√°lise">‚úé</div>
        </div>

        <div id="boxAlerta" class="alert warn">
          Preencha <b>Estoque atual</b>, o <b>realizado</b> e clique em <b>üìå Preencher tend√™ncia</b>, depois <b>Analisar</b>.
        </div>

        <!-- ‚úÖ Plano de a√ß√£o / oportunidades -->
        <div class="sectionBox" style="margin-top:10px;">
          <h3>üß≠ Oportunidades & Plano de A√ß√£o</h3>
          <div class="miniNote" style="margin:0 0 10px 0;">
            Motor ‚ÄúIA local‚Äù cruza motivo + tend√™ncia + risco para sugerir contorno e oportunidade (reduz/segura/rampeia).
          </div>
          <div class="alert" id="boxAcoes" style="margin-top:0;">
            Rode a an√°lise pra gerar recomenda√ß√µes.
          </div>
        </div>
      </div>

      <div class="btnRow">
        <button id="btnSimular">‚ñ∂Ô∏è Analisar & Projetar</button>
        <button class="secondary" id="btnPDF">üßæ Exportar PDF</button>
      </div>

      <div class="miniNote" style="margin-top:10px;">
        ‚ö†Ô∏è Integra√ß√£o com ‚ÄúAtlas Agro IA (GPT)‚Äù via link: precisa backend/API (n√£o d√° pra chamar o GPT direto do HTML). J√° deixei um gancho no c√≥digo, se voc√™ quiser plugar.
      </div>
    </div>
  </div>

  <!-- DIREITA -->
  <div class="main">

    <div class="card" id="kpiCard">
      <div class="hd">
        <h2>üìå KPIs</h2>
        <div class="hint" id="kpiHint">‚Äî</div>
      </div>
      <div class="bd">
        <div class="kpis">
          <div class="kpi">
            <div class="t">Estoque atual</div>
            <div class="v" id="kpiEstAtualConj">‚Äî</div>
            <div class="s">conj</div>
          </div>
          <div class="kpi">
            <div class="t">Estoque em horas (‚âà)</div>
            <div class="v" id="kpiEstHoras">‚Äî</div>
            <div class="s">h</div>
          </div>
          <div class="kpi">
            <div class="t">M√©dia de moagem ind√∫stria</div>
            <div class="v" id="kpiMediaIndustria">‚Äî</div>
            <div class="s">t/h</div>
          </div>
          <div class="kpi">
            <div class="t">M√©dia de entrada agr√≠cola</div>
            <div class="v" id="kpiMediaAgricola">‚Äî</div>
            <div class="s">t/h</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card" id="chartCard">
      <div class="hd">
        <h2>üìà Proje√ß√£o do Estoque (conj)</h2>
        <div class="hint">linha vertical = hora cr√≠tica ‚Ä¢ zonas (verde/amarelo/vermelho)</div>
      </div>
      <div class="bd">
        <div class="canvasWrap" id="chartWrap">
          <canvas id="chart"></canvas>
        </div>

        <div class="btnRow" style="margin-top:10px;">
          <button class="ghost" id="btnChecklist">üß≠ O que fazer (checklist)</button>
        </div>
      </div>
    </div>

    <div class="card" id="resultCard">
      <div class="hd">
        <h2>üß† Resultado hora a hora</h2>
        <div class="hint">estoque em conj e t (batendo com o gr√°fico)</div>
      </div>
      <div class="bd">
        <div class="tableWrap" id="resultTable"></div>
      </div>
    </div>

  </div>
</div>

<!-- Modal CTT -->
<div class="modalOverlay" id="modalOverlay">
  <div class="modal">
    <div class="modalHd">
      <h3>üìò Sobre CTT, Estoque, C√°lculos e L√≥gica de Redu√ß√£o (tutorial COA)</h3>
      <div class="modalClose" id="modalClose">Fechar</div>
    </div>
    <div class="modalBd" id="cttBody"></div>
  </div>
</div>

<!-- Modal Mensagem da an√°lise -->
<div class="modalOverlay" id="modalOverlayMsg">
  <div class="modal">
    <div class="modalHd">
      <h3>üì® Mensagem da an√°lise (texto pronto)</h3>
      <div class="modalClose" id="modalCloseMsg">Fechar</div>
    </div>
    <div class="modalBd">
      <div class="box">
        <div id="msgText" style="white-space:pre-wrap;color:#e8efff;"></div>
        <div class="toolbar">
          <button class="secondary" id="btnCopyMsg">üìé Copiar texto</button>
          <div class="spacer"></div>
          <span style="color:var(--muted);font-size:12px;">(usa a an√°lise confirmada/editada)</span>
        </div>
      </div>
      <div class="miniNote">Texto pronto no padr√£o COA: objetivo, t√©cnico e coerente com gr√°fico/tabela.</div>
    </div>
  </div>
</div>

<!-- Modal Checklist -->
<div class="modalOverlay" id="modalOverlayChecklist">
  <div class="modal">
    <div class="modalHd">
      <h3>üß≠ Checklist r√°pido ‚Äî ‚ÄúO que fazer agora?‚Äù</h3>
      <div class="modalClose" id="modalCloseChecklist">Fechar</div>
    </div>
    <div class="modalBd">
      <div class="box" id="checklistBody"></div>
      <div class="miniNote">Esse checklist √© s√≥ apoio operacional (n√£o entra no PDF).</div>
    </div>
  </div>
</div>

<!-- Modal Aviso/Confirma√ß√£o -->
<div class="modalOverlay" id="modalOverlayConfirm">
  <div class="modal">
    <div class="modalHd">
      <h3>‚úÖ An√°lise gerada</h3>
      <div class="modalClose" id="modalCloseConfirm">Fechar</div>
    </div>
    <div class="modalBd">
      <div class="box" style="margin-top:0;">
        <div style="color:var(--muted);font-size:12px;margin-bottom:8px;">
          A an√°lise foi gerada. Se precisar ajustar algo, clique no <b>‚úé</b> ao lado do Informativo e edite. Depois, confirme.
        </div>
        <div class="toolbar">
          <div class="spacer"></div>
          <button id="btnConfirmar">‚úÖ Confirmar an√°lise</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Edi√ß√£o -->
<div class="modalOverlay" id="modalOverlayEdit">
  <div class="modal">
    <div class="modalHd">
      <h3>‚úé Editar Informativo</h3>
      <div class="modalClose" id="modalCloseEdit">Fechar</div>
    </div>
    <div class="modalBd">
      <div class="box" style="margin-top:0;">
        <label style="margin-top:0;">Texto final (vai para PDF e Mensagem da an√°lise)</label>
        <textarea id="inEditAnalise" style="min-height:260px;"></textarea>
        <div class="toolbar">
          <button class="secondary" id="btnCancelarEdicao">‚Ü© Cancelar</button>
          <div class="spacer"></div>
          <button id="btnSalvarEdicao">üíæ Salvar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Offscreen PDF compositor -->
<div class="pdfStage" id="pdfStage">
  <div class="pdfPage" id="pdfPage1"></div>
  <div class="pdfPage" id="pdfPage2"></div>
  <div class="pdfPage" id="pdfPage3"></div>
</div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // ‚úÖ SIGLAS
  const SIGLA = {
    "Cruz Alta": "UICA",
    "S√£o Jos√©": "UISJ",
    "Mandu": "UIM",
    "Tanabi": "UIT",
    "Vertente": "VER"
  };

  // Par√¢metros por unidade
  const UNITS = {
    "Cruz Alta": { nominal: 900,  minMoagem: 600, min: 1350, max: 1800, agricolaPadrao: 897, industriaPadrao: 900, riscoT: 900, paradaConj: 6, difOffMin: 250 },
    "Mandu":     { nominal: 917,  minMoagem: 600, min: 1376, max: 1834, agricolaPadrao: 917, industriaPadrao: 917, riscoT: 900, paradaConj: 6 },
    "S√£o Jos√©":  { nominal: 750,  minMoagem: 570, min: 1125, max: 1500, agricolaPadrao: 750, industriaPadrao: 750, riscoT: 700, paradaConj: 6 },
    "Tanabi":    { nominal: 710,  minMoagem: 450, min: 1065, max: 1420, agricolaPadrao: 710, industriaPadrao: 710, riscoT: 700, paradaConj: 6 },
    "Vertente":  { nominal: 500,  minMoagem: 400, min: 900,  max: 1250, agricolaPadrao: 500, industriaPadrao: 500, riscoT: 500, paradaConj: 3 },
  };

  const REAL_HOURS = 3;

  let chart;
  let lastPlan = null;
  let lastProjBase = null;
  let lastDensUsed = 70;

  let generatedAnalysisText = "‚Äî";
  let finalAnalysisText = "‚Äî";
  let lastStatusForBeep = null;

  // ====== SOM (s√≥ ap√≥s intera√ß√£o) ======
  let soundArmed = false;
  let audioCtx = null;
  function armSound(){
    try{
      if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      soundArmed = true;
      $("btnArmarSom").textContent = "‚úÖ Som armado";
      setTimeout(()=> $("btnArmarSom").textContent = "üîä Som armado", 1200);
    }catch(e){
      alert("Navegador bloqueou √°udio. Tenta usar Chrome/Edge.");
    }
  }
  function beep(freq=880, ms=120, gain=0.04){
    if(!soundArmed || !audioCtx) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "sine";
    o.frequency.value = freq;
    g.gain.value = gain;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); }, ms);
  }
  function beepForStatus(status){
    if(status === lastStatusForBeep) return;
    lastStatusForBeep = status;
    if(status === "CR√çTICO"){ beep(980,160,0.06); setTimeout(()=>beep(780,160,0.06), 190); }
    else if(status === "ALERTA"){ beep(880,140,0.05); }
    else if(status === "OK"){ beep(660,110,0.03); }
  }

  function pad2(n){ return String(n).padStart(2,'0'); }
  function nowStr(){
    const d = new Date();
    return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  }
  function hourLabel(date){ return `${pad2(date.getHours())}:00`; }
  function hourMinus(h){ const d = new Date(); d.setHours(d.getHours()-h); return hourLabel(d); }
  function hourPlus(h){ const d = new Date(); d.setHours(d.getHours()+h); return hourLabel(d); }
  function round1(x){ return Math.round(x*10)/10; }
  function round2(x){ return Math.round(x*100)/100; }
  function avg(arr){ return arr.reduce((a,b)=>a+b,0)/Math.max(1,arr.length); }

  function dens(){
    const v = Number($("inDens").value);
    return (Number.isFinite(v) && v>0) ? v : 70;
  }
  function conjToTons(conj, d){ return Number(conj) * d; }
  function tonsToConj(t, d){ return Number(t) / d; }

  function toIntConj(value){
    const n = Number(value);
    if(!Number.isFinite(n)) return null;
    return Math.max(0, Math.round(n));
  }

  function stepForUnit(){ return 50; }

  function getMinMoagem(unitName){
    const u = UNITS[unitName];
    if(unitName === "Cruz Alta" && $("inDifOff") && $("inDifOff").checked){
      return u.difOffMin ?? u.minMoagem;
    }
    return u.minMoagem;
  }

  function applyUnitDefaults(){
    const uName = $("inUnidade").value;
    $("hdrUnidade").textContent = uName;
    const u = UNITS[uName];

    $("inMin").value = u.min;
    $("inMax").value = u.max;
    $("inNominal").value = u.nominal;
    $("inRiscoT").value = u.riscoT;

    const isCA = (uName === "Cruz Alta");
    $("cruzAltaBox").style.display = isCA ? "block" : "none";

    $("inMinMoagem").value = getMinMoagem(uName);

    $("kpiHint").textContent = `Meta: nominal (${u.nominal} t/h). Ajustes em passos de 50 t/h (100 t/h s√≥ em emerg√™ncia/estoque cr√≠tico).`;
  }

  function buildLast(){
    const rows = [];
    for(let i=REAL_HOURS; i>=1; i--) rows.push(hourMinus(i));
    $("lastBody").innerHTML = rows.map((h,i)=>`
      <tr>
        <td style="font-weight:950; color:#cfe0ff;">${h}</td>
        <td><input id="l_est_${i}" type="number" step="1" placeholder="ex: 24"></td>
        <td><input id="l_agricola_${i}" type="number" step="1" placeholder="(opcional)"></td>
        <td><input id="l_industria_${i}" type="number" step="1" placeholder="(opcional)"></td>
      </tr>
    `).join("");

    for(let i=0;i<REAL_HOURS;i++){
      const el = $(`l_est_${i}`);
      el.addEventListener("input", () => {
        if(el.value === "") return;
        const v = toIntConj(el.value);
        if(v === null) return;
        el.value = String(v);
      });
    }
  }

  function buildFutureTable(){
    const period = Number($("inHorizonte").value);
    const u = UNITS[$("inUnidade").value];
    $("futureWrap").innerHTML = `
      <table>
        <thead>
          <tr>
            <th style="width:90px;">Hora</th>
            <th>üöö Entrada agr√≠cola (t/h)</th>
            <th>üè≠ Moagem ind√∫stria (t/h)</th>
          </tr>
        </thead>
        <tbody>
          ${Array.from({length:period}, (_,i)=>`
            <tr>
              <td style="font-weight:950; color:#cfe0ff;">${hourPlus(i+1)}</td>
              <td><input id="f_agricola_${i}" type="number" step="1" value="${u.agricolaPadrao}"></td>
              <td><input id="f_industria_${i}" type="number" step="1" value="${u.industriaPadrao}"></td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
  }

  function readRealizado(dUsed){
    const u = UNITS[$("inUnidade").value];
    const rows = [];
    for(let i=0;i<REAL_HOURS;i++){
      const hora = $("lastBody").children[i].children[0].textContent.trim();

      const estC = toIntConj($(`l_est_${i}`).value);
      if(estC === null) return { ok:false, err:"Preencha o ESTOQUE (conj inteiro) nas √∫ltimas 3 horas." };

      const ag = $(`l_agricola_${i}`).value.trim()==="" ? null : Number($(`l_agricola_${i}`).value);
      const ind = $(`l_industria_${i}`).value.trim()==="" ? null : Number($(`l_industria_${i}`).value);

      if(ag!==null && !Number.isFinite(ag)) return { ok:false, err:"Entrada agr√≠cola inv√°lida no realizado." };
      if(ind!==null && !Number.isFinite(ind)) return { ok:false, err:"Moagem ind√∫stria inv√°lida no realizado." };

      rows.push({
        hora,
        estoqueConj: estC,
        estoqueT: conjToTons(estC, dUsed),
        agricolaTph: ag,
        industriaTph: ind
      });
    }

    const agFilled = rows.filter(r=>r.agricolaTph!==null).map(r=>r.agricolaTph);
    const indFilled = rows.filter(r=>r.industriaTph!==null).map(r=>r.industriaTph);

    const agricolaTrend = agFilled.length ? avg(agFilled) : u.agricolaPadrao;
    const industriaTrend = indFilled.length ? avg(indFilled) : u.industriaPadrao;

    return { ok:true, rows, agricolaTrend, industriaTrend };
  }

  function fillFutureAutomatically(agAuto, indAuto){
    const period = Number($("inHorizonte").value);
    for(let i=0;i<period;i++){
      const a = document.getElementById(`f_agricola_${i}`);
      const b = document.getElementById(`f_industria_${i}`);
      if(a) a.value = Math.round(agAuto);
      if(b) b.value = Math.round(indAuto);
    }
  }

  function readFuture(){
    const period = Number($("inHorizonte").value);
    const arr = [];
    for(let i=0;i<period;i++){
      const ag = Number($(`f_agricola_${i}`).value);
      const ind = Number($(`f_industria_${i}`).value);
      if(!Number.isFinite(ag) || !Number.isFinite(ind)){
        return { ok:false, err:"Previs√£o futura inv√°lida (entrada/moagem)." };
      }
      arr.push({ hora: hourPlus(i+1), agricolaTph: ag, industriaTph: ind });
    }
    return { ok:true, arr };
  }

  function classify(estoqueT, u, dUsed){
    const conj = Math.max(0, Math.round(tonsToConj(estoqueT, dUsed)));
    if(estoqueT <= 0) return {z:"bad", t:"Risco de parada", leitura:"Parada iminente por falta de cana"};
    if(conj <= u.paradaConj) return {z:"bad", t:"Risco de parada", leitura:`Estoque muito baixo (‚â§ ${u.paradaConj} conj) ‚Äî risco elevado de faltar cana`};
    if(estoqueT < u.riscoT) return {z:"warn", t:"Zona de risco", leitura:"Zona de risco: corre√ß√£o antecipada para proteger a moagem"};
    return {z:"good", t:"Controlado", leitura:"Cen√°rio controlado"};
  }

  // ======= IA LOCAL: leitura do motivo + a√ß√µes =======
  function normalizeText(s){
    return (s||"").toLowerCase()
      .normalize("NFD").replace(/\p{Diacritic}/gu,"")
      .replace(/\s+/g," ").trim();
  }

  function extractSignals(raw){
    const t = normalizeText(raw);
    const has = (re)=> re.test(t);

    const signals = {
      raw: (raw||"").trim(),
      hasText: !!(raw||"").trim(),
      manut: has(/\b(quebra|quebrou|falha|parad|manutenc|mecan|nao liga|nao comunica|sem sinal)\b/),
      chuva: has(/\bchuva|temporal|garoa|pancada|lamace|solo umid|encharc|atoleir|nublado\b/),
      logistica: has(/\b(balanca|fila|pati|patio|transito|congestion|retorno|demora|espera|janela|carregamento|descarga)\b/),
      interdicao: has(/\b(interd|bloque|estrada|ponte|atoleiro|desvio|obra)\b/),
      turno: has(/\b(troca de turno|virada|turno)\b/),
      frente: has(/\b(frente|mudanca de frente|mudanca frente|talhao|talhao|setor)\b/),
      ativoColh: has(/\bcolhedor|colhedora|colhedoras\b/),
      ativoTrans: has(/\btransbord\b/),
      ativoCam: has(/\b(caminhao|caminhoes|frota|canavieir)\b/)
    };

    let tema = "geral";
    if(signals.manut) tema = "manutencao";
    else if(signals.interdicao) tema = "interdicao";
    else if(signals.chuva) tema = "chuva";
    else if(signals.logistica) tema = "logistica";
    else if(signals.turno) tema = "turno";
    else if(signals.frente) tema = "frente";
    signals.tema = tema;

    return signals;
  }

  // padroniza (sem inventar)
  function padronizarMotivo(raw){
    const t0 = (raw||"").trim();
    if(!t0) return "";

    let t = t0.replace(/\s+/g, " ").trim();

    const imGatilho = /\b(quebra(?:s)?|quebrou|quebrada|falha(?:s)?|parou|parada|n√£o\s*liga|nao\s*liga|n√£o\s*comunica|nao\s*comunica|sem\s*sinal|mec[a√¢]n|manuten[c√ß][a√£]o)\b/ig;
    t = t.replace(imGatilho, () => "indisponibilidade mec√¢nica");

    const hasColh = /\bcolhed(or|ora|oras|ores)\b/i.test(t);
    const hasTrans = /\btransbord(o|os)\b/i.test(t);
    const hasCam = /\b(caminh[a√£]o|caminh[√µo]es|canavieir(o|os)|frota)\b/i.test(t);

    const fonte = (()=> {
      const m = t.match(/\b(pr[o√≥]prias?|terceir(as|os)?|fornecedor(es)?|forn)\b/i);
      return m ? m[0] : "";
    })();

    function ativo(){
      if(hasColh) return "colhedoras";
      if(hasTrans) return "transbordos";
      if(hasCam) return "caminh√µes";
      return "";
    }

    const a = ativo();
    if(a){
      if(!new RegExp(`indisponibilidade mec√¢nica\\s+de\\s+${a}`, "i").test(t)){
        t = t.replace(/indisponibilidade mec√¢nica/ig, (m) => {
          const suf = fonte ? ` de ${a} ${fonte}` : ` de ${a}`;
          return m + suf;
        });
      }
    }

    t = t.replace(/\bsolo\s+umido\b/ig, "solo √∫mido");
    t = t.replace(/\bmudan[c√ß]a\s+frente\b/ig, "mudan√ßa de frente");
    t = t.replace(/\btroca\s+turno\b/ig, "troca de turno");
    t = t.replace(/\bbalanca\b/ig, "balan√ßa");
    t = t.replace(/\bpati[o√≥]\b/ig, "p√°tio");

    return t;
  }

  // ‚Äúmelhora‚Äù o motivo no padr√£o COA (sem inventar dado)
  function melhorarMotivoCOA(raw){
    const base = padronizarMotivo(raw);
    if(!base) return "";
    const s = extractSignals(base);

    const ativo = s.ativoColh ? "colheita (colhedoras)" : s.ativoTrans ? "colheita (transbordos)" : s.ativoCam ? "transporte (caminh√µes)" : "opera√ß√£o";
    const cab = `Cen√°rio associado a ${ativo}`;

    let complemento = "";
    if(s.tema === "manutencao") complemento = "com reflexo direto na entrega de cana e no balan√ßo entrada x consumo.";
    if(s.tema === "logistica") complemento = "com impacto em filas/tempos de ciclo e instabilidade de chegada.";
    if(s.tema === "chuva") complemento = "com efeito em colheitabilidade, deslocamento e/ou trafegabilidade.";
    if(s.tema === "interdicao") complemento = "com restri√ß√£o de trajeto e perda de capacidade log√≠stica.";
    if(s.tema === "turno") complemento = "com varia√ß√£o de ritmos na virada e reacomoda√ß√£o de frota/equipe.";
    if(s.tema === "frente") complemento = "com ajuste de frente/talh√£o e adapta√ß√£o de ritmo operacional.";

    // mant√©m o conte√∫do do usu√°rio e s√≥ ‚Äúenquadra‚Äù
    const final =
`${cab}. ${base.charAt(0).toUpperCase() + base.slice(1)}.
Leitura: ${complemento || "com necessidade de ajuste fino e monitoramento hora a hora."}`;

    return final;
  }

  function actionRecommendations(signals){
    // foco: contorno do motivo + melhoria
    const a = [];
    if(!signals.hasText){
      a.push("‚Ä¢ Motivo n√£o informado: descreva causa principal (manuten√ß√£o/log√≠stica/chuva/interdi√ß√£o) para recomenda√ß√µes mais certeiras.");
      return a;
    }

    if(signals.tema === "manutencao"){
      a.push("‚Ä¢ Manuten√ß√£o: abrir criticidade do(s) ativo(s) (colhedora/transbordo/caminh√£o), janela e % indisponibilidade. Priorizar retorno dos conjuntos que sustentam o fluxo.");
      a.push("‚Ä¢ Mitiga√ß√£o: reequilibrar frente com melhor colheitabilidade, refor√ßar transbordo/caminh√£o onde tiver gargalo, e reduzir varia√ß√£o (evitar picos de falha em cascata).");
    }
    if(signals.tema === "logistica"){
      a.push("‚Ä¢ Log√≠stica: validar gargalo (balan√ßa/p√°tio/estrada) e tratar fila (ordenar chegada, janela de descarga, fluxo p√°tio‚Üímoenda).");
      a.push("‚Ä¢ Mitiga√ß√£o: ajustar roteiriza√ß√£o, escalonar frota e segurar picos de chegada para evitar ‚Äúcomboio‚Äù na frente.");
    }
    if(signals.tema === "chuva"){
      a.push("‚Ä¢ Chuva/solo √∫mido: mapear frentes cr√≠ticas, alternar talh√µes com melhor suporte, reduzir manobras em √°rea sens√≠vel e ajustar velocidade/rota.");
      a.push("‚Ä¢ Mitiga√ß√£o: antecipar manuten√ß√£o preventiva (limpeza/esteira/pneus), evitar atolamento e aumentar previsibilidade de chegada.");
    }
    if(signals.tema === "interdicao"){
      a.push("‚Ä¢ Interdi√ß√£o: confirmar desvio e tempo adicional de ciclo. Se necess√°rio, criar corredor log√≠stico tempor√°rio (rota alternativa + prioriza√ß√£o de descarga).");
      a.push("‚Ä¢ Mitiga√ß√£o: travar planos de frente com menor depend√™ncia do trecho e refor√ßar comunica√ß√£o com campo/portaria.");
    }
    if(signals.tema === "turno"){
      a.push("‚Ä¢ Troca de turno: alinhar janela de troca para n√£o ‚Äúzerar‚Äù a chegada. Garantir transi√ß√£o de apontamento e retorno dos conjuntos.");
    }
    if(signals.tema === "frente"){
      a.push("‚Ä¢ Mudan√ßa de frente: confirmar setup (mapa, talh√£o, dist√¢ncia, equipe) e evitar hiato de entrega na virada.");
    }

    // gerais
    a.push("‚Ä¢ Regra COA: estabilizar vari√¢ncia (menos picos), porque estoque quebra quando entrada oscila com consumo fixo.");
    a.push("‚Ä¢ Reavaliar hora a hora: se a proje√ß√£o virar positiva (entrada > moagem), rampear em degraus para recuperar nominal com seguran√ßa.");

    return a;
  }

  function simulateProjection(estoqueStartT, futureArr){
    let estoque = Math.max(0, estoqueStartT);
    const proj = [{hora: $("inHoraAtual").value, estoqueT: estoque, agricolaTph:null, industriaTph:null}];
    for(let i=0;i<futureArr.length;i++){
      const row = futureArr[i];
      estoque = estoque + (row.agricolaTph - row.industriaTph);
      if(estoque < 0) estoque = 0;
      proj.push({hora: row.hora, estoqueT: estoque, agricolaTph: row.agricolaTph, industriaTph: row.industriaTph});
    }
    return proj;
  }

  function findCritical(proj){
    let minIdx = 0;
    let minVal = proj[0]?.estoqueT ?? Infinity;
    for(let i=0;i<proj.length;i++){
      if(proj[i].estoqueT < minVal){
        minVal = proj[i].estoqueT;
        minIdx = i;
      }
    }
    return {hora: proj[minIdx].hora, index:minIdx, minTons:minVal};
  }

  function detectViradaBySlope(proj){
    // detecta virada: 2 incrementos seguidos
    for(let i=1;i<proj.length-1;i++){
      const a = proj[i-1].estoqueT;
      const b = proj[i].estoqueT;
      const c = proj[i+1].estoqueT;
      if(b > a && c > b) return {hora: proj[i].hora, idx: i};
    }
    return null;
  }

  function isNearDepletion(estoqueT, u, dUsed){
    const conj = Math.max(0, Math.round(tonsToConj(estoqueT, dUsed)));
    return conj <= u.paradaConj;
  }

  function firstRiskIndex(proj, u){
    for(let i=0;i<proj.length;i++){
      if(proj[i].estoqueT < u.riscoT) return i;
    }
    return -1;
  }

  function recoveryIndexAfter(proj, u, startIdx){
    for(let i=Math.max(0,startIdx); i<proj.length; i++){
      if(proj[i].estoqueT >= u.riscoT) return i;
    }
    return -1;
  }

  // ‚úÖ NOVO: detecta ‚Äújanela de melhora‚Äù (entrada>moagem por X horas seguidas)
  function detectRecoveryWindow(futureArr, minStreak=2){
    let streak = 0;
    let start = null;
    for(let i=0;i<futureArr.length;i++){
      const b = futureArr[i].agricolaTph - futureArr[i].industriaTph;
      if(b > 0){
        if(streak===0) start = i;
        streak++;
        if(streak>=minStreak){
          return { startIdx: start, endIdx: i };
        }
      } else {
        streak = 0;
        start = null;
      }
    }
    return null;
  }

  // ‚úÖ NOVO: ‚Äúreduz at√© certo ponto e depois retorna‚Äù
  // Estrat√©gia:
  // - Se cr√≠tico/alerta: reduzir (degrau) antes de entrar no risco e SEGURAR at√© a janela de recupera√ß√£o aparecer
  // - Ao recuperar: rampear em degraus (50) at√© nominal, validando risco
  function buildMoagemPlan(estoqueStartT, futureArr, u, dUsed){
    const unitName = $("inUnidade").value;
    const baseProj = simulateProjection(estoqueStartT, futureArr);
    const critBase = findCritical(baseProj);
    const virada = detectViradaBySlope(baseProj);

    const mediaAg = avg(futureArr.map(r=>r.agricolaTph));
    const mediaInd = avg(futureArr.map(r=>r.industriaTph));
    const balance = mediaAg - mediaInd;

    const minMoagem = getMinMoagem(unitName);
    const nominal = u.nominal;

    const step = stepForUnit();
    function roundToStep(x){ return Math.round(x/step)*step; }
    function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

    const curInd0 = roundToStep(futureArr[0]?.industriaTph ?? u.industriaPadrao);

    // ‚Äúponto de criticidade‚Äù: n√£o precisa ir pro piso sempre
    // alvo = reduz s√≥ at√© ficar ‚Äúseguro‚Äù (acima do risco), se poss√≠vel
    // regra: tentar reduzir 50/100 (em emerg) e reavaliar
    function nextDown(v, emergency){
      const s = emergency ? 100 : 50;
      return roundToStep(v - s);
    }

    let status = "OK";
    let type = "good";
    let chip = "Manter";
    let plan = { kind:"manter" };

    // Modo retomar
    if($("inModo").value === "retomar"){
      const alvoT = 2 * nominal;
      const idxOk = baseProj.findIndex(p => p.estoqueT >= alvoT);
      const horaOk = (idxOk>=0 ? baseProj[idxOk].hora : null);

      status = idxOk>=0 ? "OK" : "ALERTA";
      type = idxOk>=0 ? "good" : "warn";
      chip = idxOk>=0 ? "Soltar no m√≠nimo" : "Segurar";

      plan = { kind: "retomar", horaOk, alvoT, targetInd: minMoagem };
      return { status, type, chip, baseProj, plan, critBase, dUsed, virada, mediaAg, mediaInd };
    }

    const nearDepl = isNearDepletion(critBase.minTons, u, dUsed);
    const clsMin = classify(critBase.minTons, u, dUsed);

    // ‚úÖ Janela futura de recupera√ß√£o
    const recWin = detectRecoveryWindow(futureArr, 2);

    // CR√çTICO: encostou no cr√≠tico em conjuntos
    if(nearDepl){
      status = "CR√çTICO";
      type = "bad";
      chip = "Reduzir (piso)";

      const reduceAt = baseProj[1]?.hora ?? futureArr[0]?.hora ?? "‚Äî";

      // quando aumentar: na virada / recupera√ß√£o
      const recIdx = recoveryIndexAfter(baseProj, u, critBase.index);
      const increaseAt = (recWin ? baseProj[recWin.startIdx+1]?.hora : null) || (virada?.hora) || (recIdx>0 ? baseProj[recIdx].hora : null);

      plan = {
        kind: (curInd0 <= minMoagem) ? "parada" : "reduzir",
        targetInd: minMoagem,
        reduceAt,
        holdUntil: increaseAt, // segurar at√© aqui
        increaseAt
      };
      return { status, type, chip, baseProj, plan, critBase, dUsed, virada, mediaAg, mediaInd };
    }

    // ALERTA: entra em risco (amarelo) ou pior
    if(clsMin.z === "bad" || clsMin.z === "warn"){
      status = (clsMin.z === "bad") ? "CR√çTICO" : "ALERTA";
      type = (clsMin.z === "bad") ? "bad" : "warn";
      chip = "Reduzir em escala";

      const emergency = (clsMin.z==="bad");

      const idxRisk = firstRiskIndex(baseProj, u);
      const reduceIdx = (idxRisk > 1) ? (idxRisk - 1) : 1;
      const reduceAt = baseProj[reduceIdx]?.hora ?? (futureArr[0]?.hora ?? "‚Äî");

      // alvo de redu√ß√£o: ‚Äúat√© certo ponto‚Äù
      // tenta reduzir 1 degrau e, se ainda fica em risco, reduz mais um (limitado ao piso)
      let alvo = clamp(nextDown(curInd0, emergency), minMoagem, nominal);
      // simula com alvo fixo (n√£o perfeito, mas d√° dire√ß√£o)
      // se ainda assim fica em risco forte, indica piso como conting√™ncia
      if(alvo > minMoagem && (u.riscoT - critBase.minTons) > 0){
        // se margem de risco for grande, empurra mais um degrau (sem ser brusco)
        const needExtra = (u.riscoT - critBase.minTons) > (0.35 * u.riscoT);
        if(needExtra) alvo = clamp(nextDown(alvo, false), minMoagem, nominal);
      }

      // quando aumentar: janela de recupera√ß√£o (entrada>moagem) OU quando recuperar >= riscoT
      const recIdx = recoveryIndexAfter(baseProj, u, critBase.index);
      const increaseAt = (recWin ? baseProj[recWin.startIdx+1]?.hora : null) || (virada?.hora) || (recIdx>0 ? baseProj[recIdx].hora : null);

      plan = {
        kind:"reduzir",
        targetInd: alvo,
        reduceAt,
        holdUntil: increaseAt,
        increaseAt
      };
      return { status, type, chip, baseProj, plan, critBase, dUsed, virada, mediaAg, mediaInd };
    }

    // OK e sobrando entrada: avaliar aumento
    if(balance > 40){
      status = "OK";
      type = "good";
      chip = "Avaliar aumento";
      const alvo = clamp(curInd0 + 50, minMoagem, nominal);
      const increaseAt = baseProj[1]?.hora ?? (futureArr[0]?.hora ?? "‚Äî");
      plan = { kind:"aumentar", targetInd: alvo, increaseAt };
      return { status, type, chip, baseProj, plan, critBase, dUsed, virada, mediaAg, mediaInd };
    }

    // default
    status = "OK";
    type = "good";
    chip = "Manter";
    plan = { kind:"manter" };
    return { status, type, chip, baseProj, plan, critBase, dUsed, virada, mediaAg, mediaInd };
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }

  function setChipsPulse(on){
    const ids = ["chipStatusWrap","chipHoraWrap","chipAcaoWrap"];
    ids.forEach(id => {
      const el = $(id);
      if(!el) return;
      if(on) el.classList.add("pulse");
      else el.classList.remove("pulse");
    });
  }

  function setStrobe(type){
    const left = $("leftCard");
    const cards = [left, $("kpiCard"), $("chartCard"), $("resultCard")].filter(Boolean);
    cards.forEach(c=>{
      c.classList.remove("strobe","bad","warn");
      if(type==="bad"){ c.classList.add("strobe","bad"); }
      if(type==="warn"){ c.classList.add("strobe","warn"); }
    });
  }

  function setInformativoBox(text, type, meta){
    const box = $("boxAlerta");
    box.className = `alert ${type}`;
    box.innerHTML = `<div style="white-space:pre-wrap; color: #e8efff;">${escapeHtml(text)}</div>`;

    $("chipStatus").textContent = meta?.status ?? "‚Äî";
    $("chipHoraCritica").textContent = meta?.horaCritica ?? "‚Äî";
    $("chipAcao").textContent = meta?.chip ?? "‚Äî";

    // ‚úÖ efeitos visuais/sonoros por status
    const status = meta?.status ?? "‚Äî";
    if(status === "CR√çTICO"){ setChipsPulse(true); setStrobe("bad"); beepForStatus("CR√çTICO"); }
    else if(status === "ALERTA"){ setChipsPulse(true); setStrobe("warn"); beepForStatus("ALERTA"); }
    else { setChipsPulse(false); setStrobe(""); beepForStatus("OK"); }

    if(text && text !== "‚Äî") $("btnEditPencil").classList.add("show");
    else $("btnEditPencil").classList.remove("show");
  }

  function renderChart(projBase, u, dUsed){
    const labels = projBase.map(p => p.hora);
    const baseConj = projBase.map(p => Math.max(0, Math.round(tonsToConj(p.estoqueT, dUsed))));

    const minConj = Math.max(0, Math.round(tonsToConj(u.min, dUsed)));
    const riscoConj = Math.max(0, Math.round(tonsToConj(u.riscoT, dUsed)));

    const crit = findCritical(projBase);
    const critIndex = crit.index;

    if(chart) chart.destroy();

    const watermarkPlugin = {
      id: "watermarkCOA",
      beforeDraw(c, args, opts){
        if(!opts || !opts.enabled) return;
        const {ctx, chartArea} = c;
        if(!chartArea) return;
        ctx.save();
        ctx.globalAlpha = opts.alpha ?? 0.08;
        ctx.fillStyle = opts.color ?? "#ffffff";
        ctx.font = `950 ${opts.size ?? 96}px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial`;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        const x = (chartArea.left + chartArea.right)/2;
        const y = (chartArea.top + chartArea.bottom)/2;
        ctx.fillText(opts.text ?? "COA", x, y);
        ctx.restore();
      }
    };

    const zonesPlugin = {
      id: 'zonesPlugin',
      beforeDraw(c){
        const {ctx, chartArea, scales} = c;
        if(!chartArea) return;
        const y = scales.y;
        ctx.save();

        const yRisco = y.getPixelForValue(riscoConj);
        const yMin = y.getPixelForValue(minConj);

        ctx.fillStyle = "rgba(25,195,125,0.10)";
        ctx.fillRect(chartArea.left, chartArea.top, chartArea.right-chartArea.left, Math.max(0, yRisco - chartArea.top));

        ctx.fillStyle = "rgba(255,176,32,0.10)";
        ctx.fillRect(chartArea.left, yRisco, chartArea.right-chartArea.left, Math.max(0, yMin - yRisco));

        ctx.fillStyle = "rgba(255,77,77,0.10)";
        ctx.fillRect(chartArea.left, yMin, chartArea.right-chartArea.left, chartArea.bottom - yMin);

        ctx.restore();
      }
    };

    const criticalLinePlugin = {
      id: "criticalLine",
      afterDatasetsDraw(c, args, opts){
        const {ctx, chartArea, scales} = c;
        if(!chartArea) return;
        const idx = opts.index;
        if(idx==null) return;

        const x = scales.x.getPixelForValue(idx);
        ctx.save();
        ctx.strokeStyle = "rgba(255,255,255,0.75)";
        ctx.lineWidth = 2;
        ctx.setLineDash([6,6]);
        ctx.beginPath();
        ctx.moveTo(x, chartArea.top);
        ctx.lineTo(x, chartArea.bottom);
        ctx.stroke();
        ctx.setLineDash([]);

        const label = `Hora cr√≠tica: ${labels[idx]}`;
        ctx.font = "950 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial";
        const w = ctx.measureText(label).width + 16;
        const bx = Math.min(chartArea.right - w, Math.max(chartArea.left, x - w/2));
        const by = chartArea.top + 8;
        ctx.fillStyle = "rgba(0,0,0,0.72)";
        ctx.fillRect(bx, by, w, 22);
        ctx.fillStyle = "rgba(255,255,255,0.95)";
        ctx.fillText(label, bx + 8, by + 15);
        ctx.restore();
      }
    };

    chart = new Chart($("chart"), {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: "Estoque projetado (conj)", data: baseConj, borderWidth: 4, tension: 0.25, pointRadius: 3, pointHoverRadius: 7, fill: true },
          { label: "Zona de risco (conj)", data: Array(labels.length).fill(riscoConj), borderWidth: 2, borderDash: [6,6], tension: 0, pointRadius: 0 },
          { label: "M√≠nimo (conj)", data: Array(labels.length).fill(minConj), borderWidth: 2, borderDash: [4,8], tension: 0, pointRadius: 0 },
        ]
      },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{ labels:{ color:"#dce6ff" } },
          tooltip:{
            callbacks:{
              label:(ctx)=>{
                const conj = ctx.parsed.y;
                const tons = conjToTons(conj, dUsed);
                return `${ctx.dataset.label}: ${conj} conj  |  ${round1(tons)} t`;
              }
            }
          },
          watermarkCOA: { enabled: true, text: "COA", alpha: 0.08, size: 96, color: "#ffffff" },
          criticalLine: { index: critIndex }
        },
        scales:{
          x:{ ticks:{ color:"#b7c6ff" }, grid:{ color:"rgba(255,255,255,0.06)" } },
          y:{ beginAtZero:true, ticks:{ color:"#b7c6ff", precision: 0 }, grid:{ color:"rgba(255,255,255,0.06)" } }
        }
      },
      plugins:[zonesPlugin, watermarkPlugin, criticalLinePlugin]
    });
  }

  function renderResultTable(proj, u, dUsed){
    $("resultTable").innerHTML = `
      <table>
        <thead>
          <tr>
            <th style="width:90px;">Hora</th>
            <th style="width:140px;">Estoque (conj)</th>
            <th style="width:140px;">Estoque (t)</th>
            <th style="width:160px;">Entrada agr√≠cola (t/h)</th>
            <th style="width:160px;">Moagem ind√∫stria (t/h)</th>
            <th style="width:150px;">Zona</th>
            <th>Leitura</th>
          </tr>
        </thead>
        <tbody>
          ${proj.map(p=>{
            const conj = Math.max(0, Math.round(tonsToConj(p.estoqueT, dUsed)));
            const c = classify(p.estoqueT, u, dUsed);
            return `
              <tr>
                <td style="font-weight:950; color:#cfe0ff;">${p.hora}</td>
                <td style="font-weight:950;">${conj}</td>
                <td style="font-weight:950;">${round1(p.estoqueT)}</td>
                <td>${(p.agricolaTph==null) ? "‚Äî" : Math.round(p.agricolaTph)}</td>
                <td>${(p.industriaTph==null) ? "‚Äî" : Math.round(p.industriaTph)}</td>
                <td><span class="pill ${c.z}">${c.t}</span></td>
                <td style="color:#b7c6ff;">${c.leitura}</td>
              </tr>
            `;
          }).join("")}
        </tbody>
      </table>
    `;
  }

  function buildInformativo(unitName, u, real, futureArr, estoqueStartT, planObj, dUsed){
    const sigla = SIGLA[unitName] ?? unitName;

    // ‚úÖ IA local melhora o motivo
    const motivoMelhorado = melhorarMotivoCOA($("inMotivo").value);
    const motivoPad = motivoMelhorado ? motivoMelhorado : padronizarMotivo($("inMotivo").value);

    const ag3 = real.rows.map(r=>r.agricolaTph).filter(v=>Number.isFinite(v));
    const ind3 = real.rows.map(r=>r.industriaTph).filter(v=>Number.isFinite(v));

    const mediaAg3 = ag3.length ? Math.round(avg(ag3)) : Math.round(avg(futureArr.map(r=>r.agricolaTph)));
    const mediaInd3 = ind3.length ? Math.round(avg(ind3)) : Math.round(avg(futureArr.map(r=>r.industriaTph)));

    const estNowConj = Math.max(0, Math.round(tonsToConj(estoqueStartT, dUsed)));
    const estNowT = round1(estoqueStartT);

    const crit = findCritical(planObj.baseProj);
    const critConj = Math.max(0, Math.round(tonsToConj(crit.minTons, dUsed)));
    const critT = round1(crit.minTons);

    const minMoagem = getMinMoagem(unitName);
    const nominal = u.nominal;

    const plan = planObj.plan || {};
    const virada = planObj.virada;

    let conduta = "";

    if(plan.kind === "retomar"){
      if(plan.horaOk){
        conduta =
`Conforme mostra o gr√°fico acima, a tend√™ncia indica estabiliza√ß√£o a partir de ${plan.horaOk}, quando o estoque consolida margem para soltar a moagem.
Conduta: retomar no m√≠nimo da unidade (${minMoagem} t/h) e rampear em degraus (50 t/h), validando ader√™ncia da chegada hora a hora at√© normalizar para a nominal (${nominal} t/h).`;
      } else {
        conduta =
`Conforme mostra o gr√°fico acima, n√£o h√° ponto claro de estabiliza√ß√£o no horizonte para soltar a moagem com seguran√ßa.
Conduta: manter postura conservadora e reavaliar a retomada quando a tend√™ncia consolidar ganho de estoque suficiente para segurar o m√≠nimo (${minMoagem} t/h).`;
      }
    } else if(plan.kind === "parada"){
      conduta =
`Conforme mostra o gr√°fico acima, mesmo com a moagem no piso (${minMoagem} t/h), a proje√ß√£o indica ruptura do estoque e risco real de parada por falta de cana.
Conduta: manter o piso e preparar conting√™ncia de parada, pois n√£o h√° margem operacional para segurar somente com ajuste interno.`;
      if(plan.reduceAt){
        conduta += ` A√ß√µes imediatas devem iniciar a partir de ${plan.reduceAt}, com monitoramento hora a hora.`;
      }
    } else if(plan.kind === "reduzir"){
      const alvo = plan.targetInd;
      const whenReduce = plan.reduceAt ? `a partir de ${plan.reduceAt}` : "a partir da pr√≥xima hora";
      conduta =
`Conforme mostra o gr√°fico acima, o menor estoque ocorre em ${crit.hora}, chegando a ${critConj} conjuntos (‚âà ${critT} t), elevando o risco de ruptura.
Conduta: ${whenReduce} ajustar a moagem em escala para ${alvo} t/h (degraus de 50 t/h; 100 t/h somente se encostar no cr√≠tico), respeitando o piso (${minMoagem} t/h), visando tirar a unidade da zona de risco e preservar margem nas pr√≥ximas horas.`;

      // ‚úÖ volta a subir quando tiver melhora (janela)
      if(plan.holdUntil){
        conduta += ` Manter esse ajuste at√© ${plan.holdUntil} (ou at√© a tend√™ncia confirmar recupera√ß√£o).`;
      }
      if(plan.increaseAt){
        conduta += ` Se a melhora se confirmar, a partir de ${plan.increaseAt} rampear novamente em degraus (50 t/h) at√© a nominal, validando ader√™ncia hora a hora.`;
      } else if(virada){
        conduta += ` Tamb√©m pontuado no gr√°fico acima, a partir de ${virada.hora} a tend√™ncia passa a recuperar estoque, permitindo rampear em degraus at√© a nominal conforme a ader√™ncia confirmar.`;
      }
    } else if(plan.kind === "aumentar"){
      const alvo = plan.targetInd;
      const whenUp = plan.increaseAt ? `a partir de ${plan.increaseAt}` : "a partir da pr√≥xima hora";
      conduta =
`Conforme mostra o gr√°fico acima, a tend√™ncia indica sustenta√ß√£o de entrada acima do consumo, com margem para recupera√ß√£o de estoque.
Conduta: ${whenUp} avaliar incremento gradual da moagem em degraus (50 t/h), com ajuste inicial para ${alvo} t/h, mantendo monitoramento hora a hora para n√£o consumir a margem e evitar retorno √† zona de risco.`;
    } else {
      conduta =
`Conforme mostra o gr√°fico acima, o cen√°rio se mant√©m controlado no horizonte analisado, com margem de estoque suficiente para seguir em nominal.
Conduta: manter a moagem e monitorar ader√™ncia de chegada, evitando quebras de ciclo que empurrem o estoque para zona de risco.`;
    }

    let p1 =
`Informativo ${sigla}

Em an√°lise, unidade est√° com moagem m√©dia em ${mediaInd3} t/h e entrega m√©dia das √∫ltimas 3 horas em ${mediaAg3} t/h, com estoque atual em ${estNowConj} conjuntos (‚âà ${estNowT} t).`;

    if(motivoPad){
      // motivo j√° vem ‚Äúem COA‚Äù
      p1 += ` ${motivoPad}`;
      if(!/[.!?]$/.test(p1.trim())) p1 += ".";
    }

    return `${p1}

${conduta}`;
  }

  function preencherTendencia(){
    const dUsed = dens();
    const estNow = toIntConj($("inEstoqueAtual").value);

    if(!Number.isFinite(dUsed) || dUsed<=0){
      setInformativoBox("Densidade inv√°lida. Informe toneladas por conjunto (ex: 70).","bad",{status:"‚Äî",horaCritica:"‚Äî",chip:"‚Äî"});
      return;
    }
    if(estNow === null){
      setInformativoBox("Preencha o estoque atual (conj) para usar como base.","bad",{status:"‚Äî",horaCritica:"‚Äî",chip:"‚Äî"});
      return;
    }

    const real = readRealizado(dUsed);
    if(!real.ok){
      setInformativoBox(real.err,"bad",{status:"‚Äî",horaCritica:"‚Äî",chip:"‚Äî"});
      return;
    }

    fillFutureAutomatically(real.agricolaTrend, real.industriaTrend);

    setInformativoBox(
      `Tend√™ncia preenchida com base no realizado. Entrada ~ ${Math.round(real.agricolaTrend)} t/h e moagem ~ ${Math.round(real.industriaTrend)} t/h. Ajuste as pr√≥ximas horas se quiser refinar.`,
      "good",
      {status:"OK",horaCritica:"‚Äî",chip:"Tend√™ncia pronta"}
    );
  }

  function openConfirmModal(){ $("modalOverlayConfirm").classList.add("open"); }
  function openEditModal(){
    if(!finalAnalysisText || finalAnalysisText==="‚Äî") return;
    $("inEditAnalise").value = finalAnalysisText;
    $("modalOverlayEdit").classList.add("open");
  }

  function updateAcoes(planObj){
    const motivoRaw = $("inMotivo").value || "";
    const signals = extractSignals(motivoRaw);
    const recs = actionRecommendations(signals);

    const plan = planObj?.plan || {};
    const extra = [];
    if(plan.kind === "reduzir"){
      extra.push(`‚Ä¢ Moagem: reduzir em escala para ${plan.targetInd} t/h ${plan.reduceAt ? `a partir de ${plan.reduceAt}` : ""}.`);
      if(plan.holdUntil) extra.push(`‚Ä¢ Segurar ajuste at√© ${plan.holdUntil} e rampear se a melhora confirmar.`);
      else if(plan.increaseAt) extra.push(`‚Ä¢ Rampear novamente a partir de ${plan.increaseAt} (50 t/h por degrau).`);
    } else if(plan.kind === "aumentar"){
      extra.push(`‚Ä¢ Moagem: avaliar aumento para ${plan.targetInd} t/h ${plan.increaseAt ? `a partir de ${plan.increaseAt}` : ""}.`);
    } else if(plan.kind === "parada"){
      extra.push(`‚Ä¢ Conting√™ncia: preparar parada controlada (sem margem de estoque) e priorizar recomposi√ß√£o de chegada.`);
    } else if(plan.kind === "retomar"){
      extra.push(`‚Ä¢ Retomada: soltar no m√≠nimo (${plan.targetInd} t/h) e rampear em degraus (50 t/h) quando ader√™ncia firmar.`);
    } else {
      extra.push("‚Ä¢ Moagem: manter e monitorar varia√ß√£o de chegada (picos derrubam estoque).");
    }

    const text =
`Recomenda√ß√µes (IA local):

${recs.join("\n")}

Oportunidade / Conduta (moagem):
${extra.join("\n")}
`;
    const box = $("boxAcoes");
    box.className = `alert ${planObj?.type || "warn"}`;
    box.innerHTML = `<div style="white-space:pre-wrap; color: #e8efff;">${escapeHtml(text)}</div>`;
  }

  function analisar(){
    const dUsed = dens();
    const estNow = toIntConj($("inEstoqueAtual").value);
    if(!Number.isFinite(dUsed) || dUsed<=0){
      setInformativoBox("Densidade inv√°lida. Informe toneladas por conjunto (ex: 70).","bad",{status:"‚Äî",horaCritica:"‚Äî",chip:"‚Äî"});
      return;
    }
    if(estNow === null){
      setInformativoBox("Preencha o estoque atual (conj) para usar como base.","bad",{status:"‚Äî",horaCritica:"‚Äî",chip:"‚Äî"});
      return;
    }

    const unitName = $("inUnidade").value;
    const u = UNITS[unitName];

    const real = readRealizado(dUsed);
    if(!real.ok){
      setInformativoBox(real.err,"bad",{status:"‚Äî",horaCritica:"‚Äî",chip:"‚Äî"});
      return;
    }

    const fut = readFuture();
    if(!fut.ok){
      setInformativoBox(fut.err,"bad",{status:"‚Äî",horaCritica:"‚Äî",chip:"‚Äî"});
      return;
    }

    const estoqueStartT = conjToTons(estNow, dUsed);

    const mediaAg = avg(fut.arr.map(r=>r.agricolaTph));
    const mediaInd = avg(fut.arr.map(r=>r.industriaTph));

    $("kpiEstAtualConj").textContent = estNow;
    $("kpiEstHoras").textContent = (u.nominal>0) ? round2(estoqueStartT / u.nominal) : "‚Äî";
    $("kpiMediaAgricola").textContent = round1(mediaAg);
    $("kpiMediaIndustria").textContent  = round1(mediaInd);

    const planObj = buildMoagemPlan(estoqueStartT, fut.arr, u, dUsed);
    lastPlan = planObj;
    lastProjBase = planObj.baseProj;
    lastDensUsed = dUsed;

    const infoText = buildInformativo(unitName, u, real, fut.arr, estoqueStartT, planObj, dUsed);
    generatedAnalysisText = infoText;
    finalAnalysisText = infoText;

    const crit = findCritical(planObj.baseProj);

    setInformativoBox(infoText, planObj.type, {status: planObj.status, horaCritica: crit.hora, chip: planObj.chip});
    updateAcoes(planObj);

    renderChart(planObj.baseProj, u, dUsed);
    renderResultTable(planObj.baseProj, u, dUsed);

    openConfirmModal();
  }

  function simulateScenario(){
    const unitName = $("inUnidade").value;
    const u = UNITS[unitName];
    const dUsed = dens();
    const period = Number($("inHorizonte").value);

    if($("inModo").value === "retomar"){
      $("inEstoqueAtual").value = 0;

      for(let i=0;i<REAL_HOURS;i++){
        $(`l_est_${i}`).value = 0;
        $(`l_agricola_${i}`).value = Math.round(u.agricolaPadrao * 0.55);
        $(`l_industria_${i}`).value = 0;
      }

      const minM = getMinMoagem(unitName);
      for(let i=0;i<period;i++){
        const a = $(`f_agricola_${i}`);
        const b = $(`f_industria_${i}`);
        const grow = Math.min(1, (i+1)/6);
        a.value = Math.round(u.agricolaPadrao * (0.55 + 0.35*grow));
        b.value = Math.round(i<2 ? 0 : (i<5 ? minM : Math.min(u.nominal, minM + (i-4)*50)));
      }

      $("inMotivo").value = "p√≥s parada grande; retomando gradualmente; monitorando ader√™ncia da chegada para soltar moagem no melhor momento";

      setInformativoBox("Cen√°rio (retomar moagem) simulado. Clique em Analisar.","warn",{status:"ALERTA",horaCritica:"‚Äî",chip:"Retomar"});
      return;
    }

    const riscoConj = Math.max(0, Math.round(u.riscoT / dUsed));
    const now = Math.max(riscoConj + 4, 10);
    $("inEstoqueAtual").value = now;

    for(let i=0;i<REAL_HOURS;i++){
      const est = Math.max(0, now + (REAL_HOURS - i) * 2);
      $(`l_est_${i}`).value = est;
      $(`l_agricola_${i}`).value = Math.round(u.agricolaPadrao - (40 + Math.random()*80));
      $(`l_industria_${i}`).value = Math.round(u.industriaPadrao + (10 + Math.random()*35));
    }

    preencherTendencia();

    for(let i=0;i<period;i++){
      const a = $(`f_agricola_${i}`);
      const b = $(`f_industria_${i}`);
      if(i < 3){
        a.value = Math.round(u.agricolaPadrao - (90 + Math.random()*110));
        b.value = Math.round(u.industriaPadrao);
      } else {
        a.value = Math.round(u.industriaPadrao + 60 + Math.random()*60);
        b.value = Math.round(u.industriaPadrao);
      }
    }

    $("inMotivo").value =
      "quebra de colhedora pr√≥prias 08:00-15:00 m√©dia 15% pico 20% 11:00; fila na balan√ßa; mudan√ßa de frente; troca de turno 18:00; solo umido";

    setInformativoBox("Cen√°rio simulado carregado. Ajuste n√∫meros e clique em Analisar.","warn",{status:"ALERTA",horaCritica:"‚Äî",chip:"Testar"});
  }

  function buildChecklist(){
    const unitName = $("inUnidade").value;
    const minM = getMinMoagem(unitName);

    return `
<b>1) Valida√ß√£o r√°pida (1 minuto)</b>
‚Ä¢ Conferir estoque atual (conj) e se densidade est√° correta (t/conj).
‚Ä¢ Conferir realizado (3h) e se tend√™ncia futura est√° coerente (entrada x moagem).

<b>2) Checagens operacionais (campo/p√°tio)</b>
‚Ä¢ Colheita: indisponibilidade mec√¢nica? ‚Äî janela, pico e impacto na entrega.
‚Ä¢ Transporte: retorno alto, fila de balan√ßa/p√°tio, estrada/interdi√ß√£o, troca de turno.
‚Ä¢ Frentes: mudan√ßa de frente / baixa colheitabilidade / solo √∫mido / chuva localizada.
‚Ä¢ Industrial: restri√ß√£o de processo impactando consumo.

<b>3) Conduta padr√£o</b>
‚Ä¢ Ajustes em degraus de 50 t/h (100 t/h s√≥ em emerg√™ncia/estoque cr√≠tico).
‚Ä¢ Piso da unidade: <b>${minM} t/h</b>. Abaixo disso, conting√™ncia/parada.
‚Ä¢ Se aparecer recupera√ß√£o no gr√°fico, rampear em degraus at√© nominal.
`;
  }

  function openChecklist(){
    $("checklistBody").innerHTML = `<div style="white-space:pre-wrap;color:#e8efff;">${buildChecklist()}</div>`;
    $("modalOverlayChecklist").classList.add("open");
  }

  function buildMsgText(){
    return finalAnalysisText && finalAnalysisText !== "‚Äî" ? finalAnalysisText : "Rode a an√°lise e confirme (‚ñ∂Ô∏è).";
  }

  function openMsg(){
    $("msgText").textContent = buildMsgText();
    $("modalOverlayMsg").classList.add("open");
  }

  async function exportPDF(){
    if(!chart || !lastPlan || !lastProjBase || !finalAnalysisText || finalAnalysisText==="‚Äî"){
      setInformativoBox("Rode a an√°lise (‚ñ∂Ô∏è) e confirme antes de exportar PDF.","warn",{status:"‚Äî",horaCritica:"‚Äî",chip:"‚Äî"});
      return;
    }

    const unidade = $("inUnidade").value;
    const sigla = SIGLA[unidade] ?? unidade;
    const dstr = nowStr();
    const period = Number($("inHorizonte").value);
    const u = UNITS[unidade];
    const dUsed = lastDensUsed;

    const page1 = $("pdfPage1");
    page1.innerHTML = `
      <div class="pdfHead">
        <div>
          <div class="t1">CTT | Informativo ${sigla} - COA</div>
          <div class="t2">Gerado em: ${dstr}<br>Densidade usada: ${dUsed} t/conj ‚Ä¢ Horizonte: ${period}h</div>
        </div>
        <div class="t2" style="text-align:right;color:#c8d4ff;">
          Status: <b style="color:#fff;">${$("chipStatus").textContent}</b><br>
          Hora cr√≠tica: <b style="color:#fff;">${$("chipHoraCritica").textContent}</b><br>
          Conduta: <b style="color:#fff;">${$("chipAcao").textContent}</b>
        </div>
      </div>
      <div class="pdfGrid">
        <div class="pdfPanel">
          <h4>Gr√°fico (estoque em conjuntos)</h4>
          <div id="pdfChartImgWrap" style="flex:1;display:flex;align-items:center;"></div>
        </div>
        <div class="pdfPanel">
          <h4>Informativo (texto final)</h4>
          <div class="pdfAnalysis" id="pdfAnalysisText"></div>
        </div>
      </div>
    `;

    const chartCanvas = $("chart");
    const chartDataUrl = chartCanvas.toDataURL("image/png", 1.0);
    const img = new Image();
    await new Promise((res)=>{ img.onload=res; img.src = chartDataUrl; });
    img.style.width = "100%";
    img.style.borderRadius = "12px";
    img.style.border = "1px solid rgba(255,255,255,.12)";
    page1.querySelector("#pdfChartImgWrap").innerHTML = "";
    page1.querySelector("#pdfChartImgWrap").appendChild(img);

    page1.querySelector("#pdfAnalysisText").textContent = finalAnalysisText;

    const rows = lastProjBase.map(p => {
      const conj = Math.max(0, Math.round(tonsToConj(p.estoqueT, dUsed)));
      const c = classify(p.estoqueT, u, dUsed);
      return {
        hora: p.hora,
        conj,
        tons: round1(p.estoqueT),
        ag: (p.agricolaTph==null) ? "‚Äî" : Math.round(p.agricolaTph),
        ind:(p.industriaTph==null) ? "‚Äî" : Math.round(p.industriaTph),
        zona: c.t,
        leitura: c.leitura
      };
    });

    const perPage = 16;
    const page2Rows = rows.slice(0, perPage);
    const page3Rows = rows.slice(perPage);

    function tableHtml(rowsChunk, pageNo, totalPages){
      return `
        <div class="pdfHead">
          <div>
            <div class="t1">Resultado hora a hora | ${sigla}</div>
            <div class="t2">Gerado em: ${dstr} ‚Ä¢ P√°gina ${pageNo}/${totalPages}</div>
          </div>
          <div class="t2" style="text-align:right;color:#c8d4ff;">
            Estoque em <b>conj</b> e <b>t</b> ‚Ä¢ Entrada e Moagem em <b>t/h</b>
          </div>
        </div>
        <div class="pdfPanel" style="min-height:unset;">
          <table style="width:100%;border-collapse:collapse;font-size:12px;">
            <thead>
              <tr>
                <th style="text-align:left;padding:8px;color:#c8d4ff;border-bottom:1px solid rgba(255,255,255,.12);">Hora</th>
                <th style="text-align:left;padding:8px;color:#c8d4ff;border-bottom:1px solid rgba(255,255,255,.12);">Estoque (conj)</th>
                <th style="text-align:left;padding:8px;color:#c8d4ff;border-bottom:1px solid rgba(255,255,255,.12);">Estoque (t)</th>
                <th style="text-align:left;padding:8px;color:#c8d4ff;border-bottom:1px solid rgba(255,255,255,.12);">Entrada (t/h)</th>
                <th style="text-align:left;padding:8px;color:#c8d4ff;border-bottom:1px solid rgba(255,255,255,.12);">Moagem (t/h)</th>
                <th style="text-align:left;padding:8px;color:#c8d4ff;border-bottom:1px solid rgba(255,255,255,.12);">Zona</th>
                <th style="text-align:left;padding:8px;color:#c8d4ff;border-bottom:1px solid rgba(255,255,255,.12);">Leitura</th>
              </tr>
            </thead>
            <tbody>
              ${rowsChunk.map(r=>`
                <tr>
                  <td style="padding:7px;border-bottom:1px solid rgba(255,255,255,.06);font-weight:950;color:#e8efff;">${r.hora}</td>
                  <td style="padding:7px;border-bottom:1px solid rgba(255,255,255,.06);font-weight:950;color:#fff;">${r.conj}</td>
                  <td style="padding:7px;border-bottom:1px solid rgba(255,255,255,.06);font-weight:950;color:#fff;">${r.tons}</td>
                  <td style="padding:7px;border-bottom:1px solid rgba(255,255,255,.06);color:#e8efff;">${r.ag}</td>
                  <td style="padding:7px;border-bottom:1px solid rgba(255,255,255,.06);color:#e8efff;">${r.ind}</td>
                  <td style="padding:7px;border-bottom:1px solid rgba(255,255,255,.06);color:#e8efff;font-weight:950;">${r.zona}</td>
                  <td style="padding:7px;border-bottom:1px solid rgba(255,255,255,.06);color:#c8d4ff;">${r.leitura}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
      `;
    }

    const totalPages = 1 + (page3Rows.length ? 2 : 1);
    $("pdfPage2").innerHTML = tableHtml(page2Rows, 2, totalPages);
    $("pdfPage3").innerHTML = page3Rows.length ? tableHtml(page3Rows, 3, totalPages) : "";

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({orientation:"landscape", unit:"mm", format:"a4"});

    async function addDomAsPage(dom, isFirst){
      const canvas = await html2canvas(dom, { scale: 2, backgroundColor: "#000000" });
      const imgData = canvas.toDataURL("image/png");
      const pageW = 297, pageH = 210;
      const margin = 6;
      const w = pageW - margin*2;
      const h = (canvas.height / canvas.width) * w;
      if(!isFirst) pdf.addPage("a4","landscape");
      pdf.setFillColor(0,0,0);
      pdf.rect(0,0,pageW,pageH,"F");
      pdf.addImage(imgData, "PNG", margin, margin, w, Math.min(h, pageH - margin*2));
    }

    await addDomAsPage($("pdfPage1"), true);
    await addDomAsPage($("pdfPage2"), false);
    if(page3Rows.length){
      await addDomAsPage($("pdfPage3"), false);
    }

    pdf.save(`CTT_COA_${sigla}.pdf`);
  }

  function buildCTTContent(){
    const unitName = $("inUnidade").value;
    const u = UNITS[unitName];
    const dUsed = dens();
    const riscoConj = Math.round(u.riscoT / dUsed);
    const minM = getMinMoagem(unitName);

    $("cttBody").innerHTML = `
      <div class="box">
        <h4>1) Conceito (CTT)</h4>
        <p>Estoque = margem entre <b>entrada</b> e <b>consumo</b>: <code>Estoque(h+1) = Estoque(h) + Entrada(h) ‚àí Moagem(h)</code>.</p>
      </div>
      <div class="box">
        <h4>2) Refer√™ncias da unidade</h4>
        <p>${SIGLA[unitName] ?? unitName}: nominal <b>${u.nominal} t/h</b>, piso <b>${minM} t/h</b>, risco <b>${u.riscoT} t</b> (~${riscoConj} conj com densidade ${dUsed}).</p>
      </div>
      <div class="box">
        <h4>3) Regras de conduta</h4>
        <p>Redu√ß√£o/Aumento em degraus de <b>50 t/h</b>. Degrau de <b>100 t/h</b> somente em cen√°rio <b>cr√≠tico</b> (estoque encostando no limite cr√≠tico em conjuntos).</p>
      </div>
      <div class="box">
        <h4>4) ‚ÄúIA local‚Äù (o que eu fiz)</h4>
        <p>O sistema classifica o motivo (manuten√ß√£o/log√≠stica/chuva/interdi√ß√£o/turno/frente), melhora o texto no padr√£o COA e recomenda a√ß√µes e janela de redu√ß√£o/retomada conforme a tend√™ncia.</p>
      </div>
    `;
  }

  function openCTT(){
    buildCTTContent();
    $("modalOverlay").classList.add("open");
  }

  // ======= GANCHO OPCIONAL: IA via API (backend) =======
  // Para integrar ‚ÄúAtlas Agro IA‚Äù de forma real:
  // 1) Voc√™ cria um backend (Worker/Vercel) que chama o modelo/GPT e retorna JSON.
  // 2) Aqui voc√™ faz fetch nesse endpoint e substitui melhorarMotivoCOA/actionRecommendations.
  async function callExternalAI(payload){
    // EXEMPLO:
    // const res = await fetch("https://SEU-ENDPOINT/api/atlas", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
    // if(!res.ok) throw new Error("Falha IA");
    // return await res.json();

    // por padr√£o: desativado (sem endpoint)
    return null;
  }

  function init(){
    $("hdrData").textContent = nowStr();
    $("inHoraAtual").value = hourLabel(new Date());

    $("inUnidade").value = "Mandu";
    applyUnitDefaults();
    buildLast();
    buildFutureTable();
    buildCTTContent();

    $("inEstoqueAtual").addEventListener("input", () => {
      if($("inEstoqueAtual").value === "") return;
      const v = toIntConj($("inEstoqueAtual").value);
      if(v === null) return;
      $("inEstoqueAtual").value = String(v);
    });

    $("inDens").addEventListener("input", () => {
      buildCTTContent();
      setInformativoBox("Densidade alterada. Clique em Analisar novamente para recalcular tudo.","warn",
        {status:"ALERTA",horaCritica:"‚Äî",chip:"Recalcular"});
    });

    $("inUnidade").addEventListener("change", () => {
      applyUnitDefaults();
      buildFutureTable();
      buildCTTContent();
      buildLast();
      finalAnalysisText = "‚Äî";
      generatedAnalysisText = "‚Äî";
      $("btnEditPencil").classList.remove("show");
      $("boxAcoes").innerHTML = "Rode a an√°lise pra gerar recomenda√ß√µes.";
      setInformativoBox("Unidade alterada. Preencha estoque e clique em Preencher tend√™ncia.","warn",{status:"ALERTA",horaCritica:"‚Äî",chip:"‚Äî"});
    });

    $("inDifOff").addEventListener("change", ()=>{
      applyUnitDefaults();
      buildCTTContent();
      setInformativoBox("Configura√ß√£o Cruz Alta atualizada (difusor). Reanalise para refletir no piso de moagem.","warn",{status:"ALERTA",horaCritica:"‚Äî",chip:"Recalcular"});
    });

    $("inHorizonte").addEventListener("change", () => {
      buildFutureTable();
      setInformativoBox("Per√≠odo alterado. Voc√™ pode clicar em Preencher tend√™ncia novamente.","warn",{status:"ALERTA",horaCritica:"‚Äî",chip:"‚Äî"});
    });

    $("inModo").addEventListener("change", () => {
      setInformativoBox("Modo alterado. Se quiser, clique em Simular cen√°rio para ver o comportamento do modo escolhido.","warn",{status:"ALERTA",horaCritica:"‚Äî",chip:"Modo"});
    });

    $("btnTendencia").addEventListener("click", preencherTendencia);
    $("btnSimular").addEventListener("click", analisar);
    $("btnPDF").addEventListener("click", exportPDF);
    $("btnChecklist").addEventListener("click", openChecklist);

    $("btnArmarSom").addEventListener("click", armSound);

    $("btnMelhorarMotivo").addEventListener("click", async ()=>{
      const raw = $("inMotivo").value || "";
      const improved = melhorarMotivoCOA(raw);
      if(!improved){
        setInformativoBox("Digite um motivo primeiro pra IA local melhorar.","warn",{status:"ALERTA",horaCritica:"‚Äî",chip:"Motivo"});
        return;
      }
      $("inMotivo").value = improved;
      setInformativoBox("Motivo melhorado (IA local). Agora rode a an√°lise pra refletir na conduta.","good",{status:"OK",horaCritica:"‚Äî",chip:"Motivo OK"});
    });

    $("btnEditPencil").addEventListener("click", openEditModal);

    $("btnSalvarEdicao").addEventListener("click", ()=>{
      const t = ($("inEditAnalise").value || "").trim();
      if(!t){
        alert("O texto n√£o pode ficar vazio.");
        return;
      }
      finalAnalysisText = t;
      setInformativoBox(finalAnalysisText, lastPlan?.type || "warn", {
        status: $("chipStatus").textContent,
        horaCritica: $("chipHoraCritica").textContent,
        chip: $("chipAcao").textContent
      });
      $("modalOverlayEdit").classList.remove("open");
    });

    $("btnCancelarEdicao").addEventListener("click", ()=>{
      $("inEditAnalise").value = finalAnalysisText;
      $("modalOverlayEdit").classList.remove("open");
    });

    // menu
    const menu = $("menu");
    $("menuBtn").addEventListener("click", () => menu.classList.toggle("open"));
    $("menuFechar").addEventListener("click", () => menu.classList.remove("open"));
    document.addEventListener("click", (e)=>{
      if(!menu.contains(e.target) && e.target !== $("menuBtn")) menu.classList.remove("open");
    });

    $("menuSimular").addEventListener("click", ()=>{
      menu.classList.remove("open");
      simulateScenario();
    });

    $("menuMensagem").addEventListener("click", ()=>{
      menu.classList.remove("open");
      openMsg();
    });

    $("menuCtt").addEventListener("click", ()=>{
      menu.classList.remove("open");
      openCTT();
    });

    // Modal CTT
    const modal = $("modalOverlay");
    $("modalClose").addEventListener("click", ()=> modal.classList.remove("open"));
    modal.addEventListener("click", (e)=>{ if(e.target === modal) modal.classList.remove("open"); });

    // Modal Msg
    const mm = $("modalOverlayMsg");
    $("modalCloseMsg").addEventListener("click", ()=> mm.classList.remove("open"));
    mm.addEventListener("click", (e)=>{ if(e.target === mm) mm.classList.remove("open"); });
    $("btnCopyMsg").addEventListener("click", async ()=>{
      const txt = $("msgText").textContent || "";
      try{
        await navigator.clipboard.writeText(txt);
        $("btnCopyMsg").textContent = "‚úÖ Copiado";
        setTimeout(()=> $("btnCopyMsg").textContent = "üìé Copiar texto", 1200);
      }catch{
        alert("N√£o foi poss√≠vel copiar automaticamente. Selecione o texto e copie.");
      }
    });

    // Modal Checklist
    const mc = $("modalOverlayChecklist");
    $("modalCloseChecklist").addEventListener("click", ()=> mc.classList.remove("open"));
    mc.addEventListener("click", (e)=>{ if(e.target === mc) mc.classList.remove("open"); });

    // Modal Confirmar
    const cf = $("modalOverlayConfirm");
    $("modalCloseConfirm").addEventListener("click", ()=> cf.classList.remove("open"));
    cf.addEventListener("click", (e)=>{ if(e.target === cf) cf.classList.remove("open"); });
    $("btnConfirmar").addEventListener("click", ()=> cf.classList.remove("open"));

    // Modal Edit
    const me = $("modalOverlayEdit");
    $("modalCloseEdit").addEventListener("click", ()=> me.classList.remove("open"));
    me.addEventListener("click", (e)=>{ if(e.target === me) me.classList.remove("open"); });

    setInterval(() => {
      $("hdrData").textContent = nowStr();
      $("inHoraAtual").value = hourLabel(new Date());
    }, 60000);

    $("chipStatus").textContent = "‚Äî";
    $("chipHoraCritica").textContent = "‚Äî";
    $("chipAcao").textContent = "‚Äî";

    simulateScenario();
  }

  init();
})();
</script>

</body>
</html>
